<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Forest Tales - AR Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --forest-green: #2d5016;
      --bright-green: #4ade80;
      --leaf-green: #22c55e;
      --moss-green: #16a34a;
      --earth-brown: #78350f;
      --bark-brown: #92400e;
      --sky-blue: #0ea5e9;
      --gold: #fbbf24;
      --dark-bg: #0f1810;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Rajdhani', sans-serif;
      background: linear-gradient(135deg, #0f1810 0%, #1a2817 100%);
    }

    /* UI + Loader + Panels unchanged except icons */
    .loader {
      position: fixed; inset: 0;
      background: linear-gradient(135deg, #0f1810 0%, #1a2817 100%);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 9999; transition: opacity 0.5s, visibility 0.5s;
    }
    .loader.hidden { opacity: 0; visibility: hidden; }

    .loader-title { font-family: 'Orbitron'; font-size: 28px; font-weight: 900; color: var(--bright-green); text-shadow: 0 0 20px var(--bright-green); }
    .loader-bar { width:150px; height:2px; background:#1a2817; margin-top:20px; overflow:hidden; position:relative; }
    .loader-bar::after { content:''; position:absolute; left:-50%; width:50%; height:100%; background:linear-gradient(90deg,transparent,var(--bright-green),transparent); animation:loadingBar 1.5s infinite; }
    @keyframes loadingBar { 0%{left:-50%;} 100%{left:100%;} }

    .top-bar { position:fixed; top:0; left:0; right:0; background:linear-gradient(180deg,rgba(15,24,16,0.95),rgba(15,24,16,0.7),transparent); padding:12px 15px 20px; z-index:100; pointer-events:none; }
    .top-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .logo { font-family:'Orbitron'; font-weight:900; font-size:18px; color:var(--bright-green); letter-spacing:3px; text-shadow:0 0 10px var(--bright-green); }
    .logo span { color:var(--earth-brown); }

    .status { font-size:9px; color:#4a6340; text-align:right; }
    .status .online { color:var(--bright-green); }

    .progress-row { display:flex; gap:6px; align-items:center; }
    .chapter-dot { flex:1; display:flex; align-items:center; gap:6px; padding:6px 8px; background:rgba(15,24,16,0.6); border:1px solid #2d5016; border-radius:6px; transition:0.3s; }
    .chapter-dot.active { border-color:var(--bright-green); box-shadow:0 0 10px rgba(74,222,128,0.4); }
    .chapter-dot.active-bear { border-color:var(--earth-brown); box-shadow:0 0 10px rgba(120,53,15,0.4); }
    .chapter-dot.current { border-color:var(--gold); animation:pulse 1.5s infinite; }
    @keyframes pulse { 0%,100%{box-shadow:0 0 5px var(--gold);} 50%{box-shadow:0 0 12px var(--gold);} }

    .dot-icon { font-size:14px; }
    .dot-text { font-size:8px; color:#4a6340; text-transform:uppercase; }

    .bottom-bar { position:fixed; bottom:0; left:0; right:0; height:35px; background:linear-gradient(0deg,rgba(15,24,16,0.9),transparent); display:flex; justify-content:center; align-items:center; z-index:100; pointer-events:none; }
    .scan-hint { font-size:10px; color:#4a6340; }
    .scan-hint .target { color:var(--gold); font-weight:700; }

    .corner { position:fixed; width:20px; height:20px; border:1px solid rgba(74,222,128,0.4); z-index:50; }
    .corner-tl { top:8px; left:8px; border-right:none;border-bottom:none; }
    .corner-tr { top:8px; right:8px;border-left:none;border-bottom:none; }
    .corner-bl { bottom:8px; left:8px;border-right:none;border-top:none; }
    .corner-br { bottom:8px; right:8px;border-left:none;border-top:none; }

    .chapter-panel {
      position:fixed; bottom:50px; left:12px; right:12px;
      background:linear-gradient(135deg,rgba(15,24,16,0.95),rgba(45,80,22,0.92));
      border:1px solid var(--leaf-green); border-radius:8px;
      padding:14px 16px; z-index:150;
      opacity:0; transform:translateY(10px); transition:0.3s; pointer-events:none;
    }
    .chapter-panel.show { opacity:1; transform:translateY(0); }

    .chapter-panel.bear-theme { background:linear-gradient(135deg,rgba(15,24,16,0.95),rgba(120,53,15,0.92)); border-color:var(--earth-brown); }

    .chapter-panel-title { font-family:'Orbitron'; font-size:12px; letter-spacing:2px; }
    .chapter-panel-story { font-size:13px; color:#bbb; line-height:1.5; }
    .chapter-panel-story .neon { color:var(--bright-green); }

    .victory { position:fixed; inset:0;
      background:radial-gradient(ellipse at center,rgba(15,40,20,0.95),rgba(0,0,0,0.98));
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      z-index:300; opacity:0; visibility:hidden; transition:0.5s;
    }
    .victory.show { opacity:1; visibility:visible; }

    .victory-badge { width:70px; height:70px; border:2px solid var(--bright-green);
      border-radius:50%; display:flex; align-items:center; justify-content:center;
      font-size:35px; margin-bottom:15px; box-shadow:0 0 25px var(--bright-green);
    }
    .victory-title { font-family:'Orbitron'; font-size:18px; font-weight:900;
      color:var(--bright-green); letter-spacing:4px; text-shadow:0 0 15px var(--bright-green);
    }
    .victory-story { max-width:280px; text-align:center; }
  </style>

  <!-- Smoothing component -->
  <script>
    AFRAME.registerComponent('super-smooth', {
      schema: {
        position: {type: 'vec3'},
        rotation: {type: 'vec3'}
      },
      init: function() {
        this.smoothPos = new THREE.Vector3();
        this.smoothRot = new THREE.Euler();
        this.initialized = false;
      },
      tick: function() {
        const obj = this.el.object3D;
        if (!this.initialized) {
          this.smoothPos.copy(obj.position);
          this.smoothRot.copy(obj.rotation);
          this.initialized = true;
          return;
        }
        const factor = 0.12;
        this.smoothPos.lerp(obj.position, factor);
        this.smoothRot.x += (obj.rotation.x - this.smoothRot.x) * factor;
        this.smoothRot.y += (obj.rotation.y - this.smoothRot.y) * factor;
        this.smoothRot.z += (obj.rotation.z - this.smoothRot.z) * factor;
        obj.position.copy(this.smoothPos);
        obj.rotation.copy(this.smoothRot);
      }
    });
  </script>
</head>

<body>

  <!-- Corners -->
  <div class="corner corner-tl"></div>
  <div class="corner corner-tr"></div>
  <div class="corner corner-bl"></div>
  <div class="corner corner-br"></div>

  <!-- Loader -->
  <div class="loader" id="loader">
    <div class="loader-title">FOREST TALES</div>
    <div class="loader-bar"></div>
  </div>

  <!-- Top UI -->
  <div class="top-bar">
    <div class="top-row">
      <div class="logo">FOREST<span>TALES</span></div>
      <div class="status">AR <span class="online">ACTIVE</span><br>TRACKING</div>
    </div>

    <div class="progress-row">
      <div class="chapter-dot current" id="dot-forest">
        <span class="dot-icon">üå≤</span>
        <span class="dot-text">Forest</span>
      </div>
      <div class="chapter-dot" id="dot-bear">
        <span class="dot-icon">üêª</span>
        <span class="dot-text">Bear</span>
      </div>
      <div class="chapter-dot" id="dot-text">
        <span class="dot-icon">üí¨</span>
        <span class="dot-text">Message</span>
      </div>
    </div>
  </div>

  <!-- Bottom Hint -->
  <div class="bottom-bar">
    <div class="scan-hint">SCAN <span class="target" id="scan-target">FOREST</span></div>
  </div>

  <!-- Story Panel -->
  <div class="chapter-panel" id="chapter-panel">
    <div class="chapter-panel-header">
      <div class="chapter-panel-title" id="panel-title"></div>
      <div class="chapter-panel-status">DISCOVERED</div>
    </div>
    <div class="chapter-panel-story" id="panel-story"></div>
  </div>

  <!-- Ending Screen -->
  <div class="victory" id="victory">
    <div class="victory-badge" id="victory-badge">üå≤</div>
    <div class="victory-title" id="victory-title">JOURNEY COMPLETE</div>
    <div class="victory-subtitle" id="victory-subtitle">FOREST EXPLORED</div>
    <div class="victory-story" id="victory-story"></div>
    <button class="victory-btn" onclick="resetStory()">RESTART</button>
  </div>

  <!-- A-FRAME + AR.js -->
  <a-scene
    embedded
    renderer="colorManagement: true; physicallyCorrectLights: true; logarithmicDepthBuffer: true"
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
    id="scene">

    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; intensity: 1.0; castShadow: true" position="2 4 2"></a-entity>

    <a-assets>
      <a-asset-item id="forest-glb" src="./forest.glb"></a-asset-item>
      <a-asset-item id="bear-glb" src="./bear.glb"></a-asset-item>
    </a-assets>

    <!-- FOREST MARKER -->
    <a-nft type="nft" url="./forest/forest" smooth="true" id="marker-forest">
      <a-entity super-smooth id="forest-content">
        <a-entity gltf-model="#forest-glb"
                  position="0 0 -150"
                  scale="8 8 8"
                  rotation="-90 0 0"></a-entity>
      </a-entity>
    </a-nft>

    <!-- BEAR MARKER -->
    <a-nft type="nft" url="./bear/grizzly-bear" smooth="true" id="marker-bear">
      <a-entity super-smooth id="bear-content">

        <!-- transparent smaller forest behind bear -->
        <a-entity gltf-model="#forest-glb"
                  position="0 0 -180"
                  scale="6 6 6"
                  rotation="-90 0 0"
                  material="transparent:true; opacity:0.3"></a-entity>

        <!-- main bear -->
        <a-entity gltf-model="#bear-glb"
                  position="0 0 -120"
                  scale="22 22 22"
                  rotation="-90 0 0"
                  id="bear-model"></a-entity>

      </a-entity>
    </a-nft>

    <!-- TEXT MARKER -->
    <a-nft type="nft" url="./text/text" smooth="true" id="marker-text">
      <a-entity super-smooth id="text-content">

        <!-- transparent forest -->
        <a-entity gltf-model="#forest-glb"
                  position="0 0 -200"
                  scale="5 5 5"
                  rotation="-90 0 0"
                  material="transparent:true; opacity:0.4"></a-entity>

        <!-- bear slightly offset -->
        <a-entity gltf-model="#bear-glb"
                  position="-70 0 -120"
                  scale="18 18 18"
                  rotation="-90 0 20"></a-entity>

        <!-- speech bubble -->
        <a-entity position="70 90 -110" rotation="0 -20 0">

          <a-plane width="140" height="90"
                   color="#ffffff" opacity="0.95"
                   material="transparent:true; side:double"></a-plane>

          <a-plane width="130" height="80"
                   color="#f0f0f0" position="0 0 1"
                   material="transparent:true; side:double"></a-plane>

          <a-text value="Hello, traveler!"
                  position="-65 28 2" color="#2d5016"
                  width="240" align="center"></a-text>

          <a-text value="Welcome to my forest."
                  position="-65 8 2" color="#2d5016"
                  width="240" align="center"></a-text>

          <a-text value="May nature guide you!"
                  position="-65 -12 2" color="#16a34a"
                  width="240" align="center"></a-text>

        </a-entity>

      </a-entity>
    </a-nft>

    <a-entity camera></a-entity>
  </a-scene>

  <!-- STORY + LOGIC SCRIPT -->
  <script>
    const storyData = {
      forest: {
        title: "CHAPTER I: THE ANCIENT FOREST",
        story: `You enter a <span class="neon">mystical forest</span> filled with ancient trees.`
      },
      bear: {
        title: "CHAPTER II: THE GUARDIAN",
        story: `A <span class="neon">majestic bear</span>, guardian of the forest, acknowledges your presence.`
      },
      text: {
        title: "CHAPTER III: THE MESSAGE",
        story: `<span class="neon">"Welcome, traveler. May the wisdom of nature guide your path."</span>`
      }
    };

    const endings = {
      complete: {
        badge: "üå≤",
        title: "JOURNEY COMPLETE",
        subtitle: "FOREST WISDOM GAINED",
        story: `<p>You explored the <span class="em">mystical forest</span>.</p><p>The ancient <span class="em">guardian bear</span> shared its wisdom.</p>`
      }
    };

    let state = { forest: false, bear: false, text: false };
    let currentlyScanning = null;

    const loader = document.getElementById('loader');
    const scanTarget = document.getElementById('scan-target');
    const chapterPanel = document.getElementById('chapter-panel');
    const panelTitle = document.getElementById('panel-title');
    const panelStory = document.getElementById('panel-story');
    const victory = document.getElementById('victory');

    const dots = {
      forest: document.getElementById('dot-forest'),
      bear: document.getElementById('dot-bear'),
      text: document.getElementById('dot-text')
    };

    const markerContents = {
      forest: document.getElementById('forest-content'),
      bear: document.getElementById('bear-content'),
      text: document.getElementById('text-content')
    };

    document.getElementById('scene').addEventListener('loaded', () => {
      setTimeout(() => {
        loader.classList.add('hidden');
        markerContents.bear.setAttribute('visible', 'false');
        markerContents.text.setAttribute('visible', 'false');
      }, 1200);
    });

    const markerIds = ['marker-forest', 'marker-bear', 'marker-text'];
    markerIds.forEach(id => {
      const marker = document.getElementById(id);
      const type = id.replace('marker-', '');
      marker.addEventListener('markerFound', () => onMarkerFound(type));
      marker.addEventListener('markerLost', () => onMarkerLost(type));
    });

    function onMarkerFound(type) {
      if (type === 'forest') {
        if (state.forest) return warn("Forest already discovered");
        state.forest = true;
        markerContents.bear.setAttribute('visible', 'true');
      }
      else if (type === 'bear') {
        if (!state.forest) return warn("Find the forest first!");
        if (state.bear) return warn("Bear already discovered");
        state.bear = true;
        markerContents.text.setAttribute('visible', 'true');
      }
      else if (type === 'text') {
        if (!state.bear) return warn("Find the bear first!");
        if (state.text) return warn("Message already received");
        state.text = true;
        setTimeout(showVictory, 1200);
      }

      chapterPanel.classList.toggle('bear-theme', type === 'bear');
      panelTitle.textContent = storyData[type].title;
      panelStory.innerHTML = storyData[type].story;
      chapterPanel.classList.add('show');

      updateUI();
    }

    function onMarkerLost(type) {
      chapterPanel.classList.remove('show');
    }

    function warn(msg) {
      scanTarget.textContent = msg;
      scanTarget.style.color = "#ff6b6b";
      setTimeout(updateScanTarget, 1500);
    }

    function updateUI() {
      dots.forest.classList.toggle('active', state.forest);
      dots.forest.classList.toggle('current', !state.forest);

      dots.bear.classList.toggle('active-bear', state.bear);
      dots.bear.classList.toggle('current', state.forest && !state.bear);

      dots.text.classList.toggle('active', state.text);
      dots.text.classList.toggle('current', state.bear && !state.text);

      updateScanTarget();
    }

    function updateScanTarget() {
      scanTarget.style.color = "";
      if (!state.forest) scanTarget.textContent = "FOREST";
      else if (!state.bear) scanTarget.textContent = "BEAR";
      else if (!state.text) scanTarget.textContent = "TEXT";
      else scanTarget.textContent = "COMPLETE";
    }

    function showVictory() {
      const end = endings.complete;
      document.getElementById('victory-badge').textContent = end.badge;
      document.getElementById('victory-title').textContent = end.title;
      document.getElementById('victory-subtitle').textContent = end.subtitle;
      document.getElementById('victory-story').innerHTML = end.story;
      victory.classList.add('show');
    }

    function resetStory() {
      state = { forest: false, bear: false, text: false };
      victory.classList.remove('show');
      chapterPanel.classList.remove('show');
      markerContents.bear.setAttribute('visible', 'false');
      markerContents.text.setAttribute('visible', 'false');
      updateUI();
    }
  </script>

</body>
</html>
