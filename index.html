<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Forest Tales - AR Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --forest-green: #2d5016;
      --bright-green: #4ade80;
      --leaf-green: #22c55e;
      --moss-green: #16a34a;
      --earth-brown: #78350f;
      --bark-brown: #92400e;
      --sky-blue: #0ea5e9;
      --gold: #fbbf24;
      --dark-bg: #0f1810;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Rajdhani', sans-serif;
      background: linear-gradient(135deg, #0f1810 0%, #1a2817 100%);
    }

    .loader {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, #0f1810 0%, #1a2817 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s, visibility 0.5s;
    }
    .loader.hidden { opacity: 0; visibility: hidden; }
    .loader-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 28px;
      font-weight: 900;
      color: var(--bright-green);
      text-shadow: 0 0 20px var(--bright-green), 0 0 40px var(--leaf-green);
      letter-spacing: 6px;
    }
    .loader-bar {
      width: 150px;
      height: 2px;
      background: #1a2817;
      margin-top: 20px;
      position: relative;
      overflow: hidden;
    }
    .loader-bar::after {
      content: '';
      position: absolute;
      left: -50%;
      width: 50%;
      height: 100%;
      background: linear-gradient(90deg, transparent, var(--bright-green), transparent);
      animation: loadingBar 1.5s infinite;
    }
    @keyframes loadingBar { 0% { left: -50%; } 100% { left: 100%; } }

    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, rgba(15,24,16,0.95) 0%, rgba(15,24,16,0.7) 70%, transparent 100%);
      padding: 12px 15px 20px 15px;
      z-index: 100;
      pointer-events: none;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .logo {
      font-family: 'Orbitron', sans-serif;
      font-weight: 900;
      font-size: 18px;
      color: var(--bright-green);
      text-shadow: 0 0 10px var(--bright-green), 0 0 20px var(--leaf-green);
      letter-spacing: 3px;
    }
    .logo span { color: var(--earth-brown); text-shadow: 0 0 10px var(--bark-brown); }

    .status {
      font-size: 9px;
      color: #4a6340;
      letter-spacing: 1px;
      text-align: right;
    }
    .status .online { color: var(--bright-green); }

    .progress-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .chapter-dot {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      background: rgba(15,24,16,0.6);
      border: 1px solid #2d5016;
      border-radius: 6px;
      transition: all 0.3s;
    }
    .chapter-dot.active {
      border-color: var(--bright-green);
      box-shadow: 0 0 10px rgba(74,222,128,0.4);
    }
    .chapter-dot.active-bear {
      border-color: var(--earth-brown);
      box-shadow: 0 0 10px rgba(120,53,15,0.4);
    }
    .chapter-dot.current {
      border-color: var(--gold);
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0%, 100% { box-shadow: 0 0 5px var(--gold); } 50% { box-shadow: 0 0 12px var(--gold); } }
    .dot-icon { font-size: 14px; }
    .dot-text {
      font-size: 8px;
      color: #4a6340;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .chapter-dot.active .dot-text, .chapter-dot.current .dot-text { color: #aaa; }
    .dot-or {
      font-size: 8px;
      color: #3a4d32;
      padding: 0 2px;
    }

    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 35px;
      background: linear-gradient(0deg, rgba(15,24,16,0.9) 0%, transparent 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      pointer-events: none;
    }
    .scan-hint {
      font-size: 10px;
      color: #4a6340;
      letter-spacing: 2px;
    }
    .scan-hint .target {
      color: var(--gold);
      font-weight: 700;
    }

    .corner {
      position: fixed;
      width: 20px;
      height: 20px;
      border: 1px solid rgba(74,222,128,0.4);
      z-index: 50;
    }
    .corner-tl { top: 8px; left: 8px; border-right: none; border-bottom: none; }
    .corner-tr { top: 8px; right: 8px; border-left: none; border-bottom: none; }
    .corner-bl { bottom: 8px; left: 8px; border-right: none; border-top: none; }
    .corner-br { bottom: 8px; right: 8px; border-left: none; border-top: none; }

    .chapter-panel {
      position: fixed;
      bottom: 50px;
      left: 12px;
      right: 12px;
      background: linear-gradient(135deg, rgba(15,24,16,0.95) 0%, rgba(45,80,22,0.92) 100%);
      border: 1px solid var(--leaf-green);
      border-radius: 8px;
      padding: 14px 16px;
      z-index: 150;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s;
      pointer-events: none;
    }
    .chapter-panel.show { opacity: 1; transform: translateY(0); }
    .chapter-panel.bear-theme {
      background: linear-gradient(135deg, rgba(15,24,16,0.95) 0%, rgba(120,53,15,0.92) 100%);
      border-color: var(--earth-brown);
    }
    .chapter-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .chapter-panel-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 12px;
      color: var(--leaf-green);
      text-shadow: 0 0 8px var(--leaf-green);
      letter-spacing: 2px;
    }
    .chapter-panel.bear-theme .chapter-panel-title {
      color: var(--earth-brown);
      text-shadow: 0 0 8px var(--earth-brown);
    }
    .chapter-panel-status {
      font-size: 9px;
      color: var(--bright-green);
      letter-spacing: 1px;
    }
    .chapter-panel-story {
      font-size: 13px;
      color: #bbb;
      line-height: 1.5;
    }
    .chapter-panel-story .neon {
      color: var(--bright-green);
      font-weight: 600;
    }
    .chapter-panel.bear-theme .chapter-panel-story .neon {
      color: var(--earth-brown);
    }

    .victory {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(ellipse at center, rgba(15,40,20,0.95) 0%, rgba(0,0,0,0.98) 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 300;
      opacity: 0;
      visibility: hidden;
      transition: all 0.5s;
    }
    .victory.show { opacity: 1; visibility: visible; }
    .victory.bear-ending {
      background: radial-gradient(ellipse at center, rgba(40,25,15,0.95) 0%, rgba(0,0,0,0.98) 100%);
    }
    .victory-badge {
      width: 70px;
      height: 70px;
      border: 2px solid var(--bright-green);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 35px;
      margin-bottom: 15px;
      box-shadow: 0 0 25px var(--bright-green);
    }
    .victory.bear-ending .victory-badge {
      border-color: var(--earth-brown);
      box-shadow: 0 0 25px var(--earth-brown);
    }
    .victory-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 18px;
      font-weight: 900;
      color: var(--bright-green);
      text-shadow: 0 0 15px var(--bright-green);
      letter-spacing: 4px;
      margin-bottom: 8px;
    }
    .victory.bear-ending .victory-title {
      color: var(--earth-brown);
      text-shadow: 0 0 15px var(--earth-brown);
    }
    .victory-subtitle {
      font-size: 11px;
      color: #666;
      letter-spacing: 2px;
      margin-bottom: 20px;
    }
    .victory-story {
      max-width: 280px;
      text-align: center;
      margin-bottom: 25px;
    }
    .victory-story p {
      font-size: 12px;
      color: #888;
      line-height: 1.5;
      margin: 8px 0;
    }
    .victory-story .em { color: var(--bright-green); font-weight: 600; }
    .victory.bear-ending .victory-story .em { color: var(--earth-brown); }
    .victory-btn {
      font-family: 'Orbitron', sans-serif;
      padding: 12px 30px;
      font-size: 10px;
      letter-spacing: 2px;
      background: transparent;
      color: var(--bright-green);
      border: 1px solid var(--bright-green);
      cursor: pointer;
      transition: all 0.3s;
      pointer-events: auto;
    }
    .victory.bear-ending .victory-btn {
      color: var(--earth-brown);
      border-color: var(--earth-brown);
    }
    .victory-btn:active {
      background: var(--bright-green);
      color: #000;
    }
    .victory.bear-ending .victory-btn:active {
      background: var(--earth-brown);
    }
  </style>

  <script>
    AFRAME.registerComponent('super-smooth', {
      schema: {
        position: {type: 'vec3'},
        rotation: {type: 'vec3'}
      },
      init: function() {
        this.smoothPos = new THREE.Vector3();
        this.smoothRot = new THREE.Euler();
        this.initialized = false;
      },
      tick: function() {
        const obj = this.el.object3D;
        if (!this.initialized) {
          this.smoothPos.copy(obj.position);
          this.smoothRot.copy(obj.rotation);
          this.initialized = true;
          return;
        }
        const factor = 0.1;
        this.smoothPos.lerp(obj.position, factor);
        this.smoothRot.x += (obj.rotation.x - this.smoothRot.x) * factor;
        this.smoothRot.y += (obj.rotation.y - this.smoothRot.y) * factor;
        this.smoothRot.z += (obj.rotation.z - this.smoothRot.z) * factor;
        obj.position.copy(this.smoothPos);
        obj.rotation.copy(this.smoothRot);
      }
    });
  </script>
</head>
<body>
  <div class="corner corner-tl"></div>
  <div class="corner corner-tr"></div>
  <div class="corner corner-bl"></div>
  <div class="corner corner-br"></div>

  <div class="loader" id="loader">
    <div class="loader-title">FOREST TALES</div>
    <div class="loader-bar"></div>
  </div>

  <div class="top-bar">
    <div class="top-row">
      <div class="logo">FOREST<span>TALES</span></div>
      <div class="status">AR <span class="online">ACTIVE</span><br>TRACKING</div>
    </div>
    <div class="progress-row">
      <div class="chapter-dot current" id="dot-forest">
        <span class="dot-icon">ï¿½</span>
        <span class="dot-text">Forest</span>
      </div>
      <div class="chapter-dot" id="dot-bear">
        <span class="dot-icon">ï¿½</span>
        <span class="dot-text">Bear</span>
      </div>
      <div class="chapter-dot" id="dot-text">
        <span class="dot-icon">ï¿½</span>
        <span class="dot-text">Message</span>
      </div>
    </div>
  </div>

  <div class="bottom-bar">
    <div class="scan-hint">SCAN <span class="target" id="scan-target">FOREST</span></div>
  </div>

  <div class="chapter-panel" id="chapter-panel">
    <div class="chapter-panel-header">
      <div class="chapter-panel-title" id="panel-title">CHAPTER I: THE FOREST</div>
      <div class="chapter-panel-status">DISCOVERED</div>
    </div>
    <div class="chapter-panel-story" id="panel-story">Story content...</div>
  </div>

  <div class="victory" id="victory">
    <div class="victory-badge" id="victory-badge">ðŸŒ²</div>
    <div class="victory-title" id="victory-title">JOURNEY COMPLETE</div>
    <div class="victory-subtitle" id="victory-subtitle">FOREST EXPLORED</div>
    <div class="victory-story" id="victory-story">
      <p>You have <span class="em">explored the forest</span> and met its guardian.</p>
      <p>The <span class="em">ancient bear</span> shared wisdom with you.</p>
    </div>
    <button class="victory-btn" onclick="resetStory()">RESTART</button>
  </div>

  <a-scene
    embedded
    renderer="colorManagement: true; physicallyCorrectLights: true; logarithmicDepthBuffer: true"
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false;"
    id="scene">

    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; intensity: 1.0; castShadow: true" position="2 4 2"></a-entity>

    <a-assets>
      <img id="bark-texture" src="https://cdn.glitch.global/341720a2-4c9a-4875-8ca7-3e8e05a3e71c/bark.jpg" crossorigin="anonymous">
      <img id="grass-texture" src="https://cdn.glitch.global/341720a2-4c9a-4875-8ca7-3e8e05a3e71c/grass.jpg" crossorigin="anonymous">
    </a-assets>

    <!-- Forest marker - shows forest scene -->
    <a-nft type="nft" url="./forest/forest" smooth="true" smoothCount="50" smoothTolerance="0.08" smoothThreshold="15" id="marker-forest">
      <a-entity position="0 0 0" super-smooth>
        <!-- Forest ground -->
        <a-plane position="0 -200 0" rotation="-90 0 0" width="600" height="600" color="#2d5016"></a-plane>
        
        <!-- Trees -->
        <a-cylinder position="-150 -100 -200" radius="20" height="200" color="#78350f"></a-cylinder>
        <a-cone position="-150 50 -200" radius-bottom="60" radius-top="10" height="120" color="#2d5016"></a-cone>
        <a-cone position="-150 120 -200" radius-bottom="50" radius-top="5" height="100" color="#16a34a"></a-cone>
        
        <a-cylinder position="150 -100 -200" radius="20" height="200" color="#78350f"></a-cylinder>
        <a-cone position="150 50 -200" radius-bottom="60" radius-top="10" height="120" color="#2d5016"></a-cone>
        <a-cone position="150 120 -200" radius-bottom="50" radius-top="5" height="100" color="#16a34a"></a-cone>
        
        <a-cylinder position="0 -100 -350" radius="25" height="220" color="#78350f"></a-cylinder>
        <a-cone position="0 60 -350" radius-bottom="70" radius-top="10" height="140" color="#2d5016"></a-cone>
        <a-cone position="0 140 -350" radius-bottom="60" radius-top="5" height="120" color="#16a34a"></a-cone>
      </a-entity>
    </a-nft>

    <!-- Bear marker - shows bear in forest context -->
    <a-nft type="nft" url="./bear/grizzly-bear" smooth="true" smoothCount="50" smoothTolerance="0.08" smoothThreshold="15" id="marker-bear">
      <a-entity position="0 0 0" super-smooth>
        <!-- Small forest ground -->
        <a-plane position="0 -200 0" rotation="-90 0 0" width="400" height="400" color="#2d5016" opacity="0.8"></a-plane>
        
        <!-- Bear body (simplified) -->
        <a-entity position="0 -120 -200">
          <!-- Body -->
          <a-sphere position="0 0 0" radius="50" color="#78350f"></a-sphere>
          <a-sphere position="0 30 30" radius="35" color="#78350f"></a-sphere>
          <!-- Head -->
          <a-sphere position="0 50 50" radius="30" color="#92400e"></a-sphere>
          <!-- Ears -->
          <a-sphere position="-20 70 50" radius="12" color="#78350f"></a-sphere>
          <a-sphere position="20 70 50" radius="12" color="#78350f"></a-sphere>
          <!-- Snout -->
          <a-cylinder position="0 45 75" radius="12" height="20" rotation="90 0 0" color="#a0522d"></a-cylinder>
          <!-- Eyes -->
          <a-sphere position="-10 55 70" radius="4" color="#000000"></a-sphere>
          <a-sphere position="10 55 70" radius="4" color="#000000"></a-sphere>
          <!-- Legs -->
          <a-cylinder position="-25 -35 -10" radius="12" height="40" color="#78350f"></a-cylinder>
          <a-cylinder position="25 -35 -10" radius="12" height="40" color="#78350f"></a-cylinder>
          <a-cylinder position="-25 -35 20" radius="12" height="40" color="#78350f"></a-cylinder>
          <a-cylinder position="25 -35 20" radius="12" height="40" color="#78350f"></a-cylinder>
        </a-entity>
        
        <!-- Background tree -->
        <a-cylinder position="120 -100 -250" radius="15" height="150" color="#78350f"></a-cylinder>
        <a-cone position="120 40 -250" radius-bottom="45" radius-top="5" height="90" color="#2d5016"></a-cone>
      </a-entity>
    </a-nft>

    <!-- Text marker - shows speech bubble near bear -->
    <a-nft type="nft" url="./text/text" smooth="true" smoothCount="50" smoothTolerance="0.08" smoothThreshold="15" id="marker-text">
      <a-entity position="0 0 0" super-smooth>
        <!-- Forest ground -->
        <a-plane position="0 -200 0" rotation="-90 0 0" width="400" height="400" color="#2d5016" opacity="0.6"></a-plane>
        
        <!-- Simplified bear -->
        <a-entity position="-80 -120 -200" scale="0.8 0.8 0.8">
          <a-sphere position="0 0 0" radius="50" color="#78350f"></a-sphere>
          <a-sphere position="0 50 50" radius="30" color="#92400e"></a-sphere>
          <a-sphere position="-20 70 50" radius="12" color="#78350f"></a-sphere>
          <a-sphere position="20 70 50" radius="12" color="#78350f"></a-sphere>
        </a-entity>
        
        <!-- Speech bubble -->
        <a-entity position="100 0 -200">
          <!-- Bubble background -->
          <a-plane position="0 0 0" width="180" height="100" color="#ffffff" opacity="0.95"></a-plane>
          <a-plane position="0 0 1" width="170" height="90" color="#f0f0f0"></a-plane>
          <!-- Bubble tail -->
          <a-triangle position="-85 -30 1" rotation="0 0 -45" color="#ffffff" scale="15 15 15"></a-triangle>
          
          <!-- Text lines -->
          <a-text value="Hello, traveler!" position="-80 30 2" color="#2d5016" width="300" font="roboto"></a-text>
          <a-text value="Welcome to my forest." position="-80 10 2" color="#2d5016" width="300" font="roboto"></a-text>
          <a-text value="May nature guide you!" position="-80 -10 2" color="#16a34a" width="300" font="roboto"></a-text>
        </a-entity>
      </a-entity>
    </a-nft>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const storyData = {
      forest: {
        title: "CHAPTER I: THE ANCIENT FOREST",
        story: `You enter a <span class="neon">mystical forest</span>, where towering trees reach toward the sky. The air is fresh with the scent of <span class="neon">pine and moss</span>. Shafts of golden sunlight pierce through the canopy, illuminating the forest floor. This place feels <span class="neon">alive with magic</span>.`
      },
      bear: {
        title: "CHAPTER II: THE GUARDIAN",
        story: `A <span class="neon">majestic bear</span> emerges from the shadows. This is no ordinary creature - it is the <span class="neon">ancient guardian</span> of the forest. Its eyes gleam with wisdom accumulated over centuries. The bear acknowledges your presence with a gentle nod, as if it has been <span class="neon">expecting you</span>.`
      },
      text: {
        title: "CHAPTER III: THE MESSAGE",
        story: `The guardian bear speaks to you in a voice that echoes through your mind. <span class="neon">"Welcome, traveler. You have shown respect by entering my domain peacefully. May the wisdom of nature guide your path, and may you always remember: we are all connected in this great forest of life."</span>`
      }
    };

    const endings = {
      complete: {
        badge: "ï¿½",
        title: "JOURNEY COMPLETE",
        subtitle: "FOREST WISDOM GAINED",
        story: `<p>You have <span class="em">explored the mystical forest</span>.</p><p>The <span class="em">ancient guardian bear</span> shared its wisdom.</p><p>You leave with a deeper connection to <span class="em">nature</span>.</p>`
      }
    };

    let state = { forest: false, bear: false, text: false };

    const loader = document.getElementById('loader');
    const scanTarget = document.getElementById('scan-target');
    const chapterPanel = document.getElementById('chapter-panel');
    const panelTitle = document.getElementById('panel-title');
    const panelStory = document.getElementById('panel-story');
    const victory = document.getElementById('victory');

    const dots = {
      forest: document.getElementById('dot-forest'),
      bear: document.getElementById('dot-bear'),
      text: document.getElementById('dot-text')
    };

    document.getElementById('scene').addEventListener('loaded', () => {
      setTimeout(() => loader.classList.add('hidden'), 1500);
    });

    const markerIds = ['marker-forest', 'marker-bear', 'marker-text'];
    markerIds.forEach(id => {
      const marker = document.getElementById(id);
      if (marker) {
        const type = id.replace('marker-', '');
        marker.addEventListener('markerFound', () => onMarkerFound(type));
        marker.addEventListener('markerLost', () => chapterPanel.classList.remove('show'));
      }
    });

    function onMarkerFound(type) {
      const isBear = type === 'bear';
      chapterPanel.classList.toggle('bear-theme', isBear);
      panelTitle.textContent = storyData[type].title;
      panelStory.innerHTML = storyData[type].story;
      chapterPanel.classList.add('show');

      if (type === 'forest' && !state.forest) {
        state.forest = true;
        updateUI();
      } else if (type === 'bear' && state.forest && !state.bear) {
        state.bear = true;
        updateUI();
      } else if (type === 'text' && state.bear && !state.text) {
        state.text = true;
        updateUI();
        setTimeout(() => showVictory(), 1500);
      }
    }

    function updateUI() {
      dots.forest.classList.toggle('active', state.forest);
      dots.forest.classList.toggle('current', !state.forest);

      dots.bear.classList.toggle('active-bear', state.bear);
      dots.bear.classList.toggle('current', state.forest && !state.bear);

      dots.text.classList.toggle('active', state.text);
      dots.text.classList.toggle('current', state.bear && !state.text);

      if (!state.forest) scanTarget.textContent = 'FOREST';
      else if (!state.bear) scanTarget.textContent = 'BEAR';
      else if (!state.text) scanTarget.textContent = 'TEXT';
      else scanTarget.textContent = 'COMPLETE';
    }

    function showVictory() {
      const end = endings.complete;
      victory.classList.remove('bear-ending');
      document.getElementById('victory-badge').textContent = end.badge;
      document.getElementById('victory-title').textContent = end.title;
      document.getElementById('victory-subtitle').textContent = end.subtitle;
      document.getElementById('victory-story').innerHTML = end.story;
      victory.classList.add('show');
    }

    function resetStory() {
      state = { forest: false, bear: false, text: false };
      victory.classList.remove('show', 'bear-ending');
      chapterPanel.classList.remove('bear-theme');
      Object.values(dots).forEach(d => d.classList.remove('active', 'active-bear', 'current'));
      dots.forest.classList.add('current');
      scanTarget.textContent = 'FOREST';
    }
  </script>
</body>
</html>
